<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Panel de Bienestar con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .file-drop-zone { transition: all 0.3s ease; }
        .file-drop-zone.dragover { border-color: #f97316; background-color: #fff7ed; }
        .nav-link { transition: all 0.3s ease; border-bottom: 2px solid transparent; }
        .nav-link.active { color: #f97316; border-bottom-color: #f97316; }
        #auth-screen, #upload-screen, #questionnaire-screen, #results-screen, #loading-screen, #history-screen { display: none; }
        .dot-pulse { animation: dotPulse 1.5s infinite ease-in-out; }
        .dot-pulse:nth-child(2) { animation-delay: 0.2s; }
        .dot-pulse:nth-child(3) { animation-delay: 0.4s; }
        @keyframes dotPulse { 0%, 100% { transform: scale(0.8); opacity: 0.8; } 50% { transform: scale(1.2); opacity: 1; } }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; background-color: #ffffff !important; }
            header, footer.web-footer, .no-print { display: none !important; }
            main { padding: 0 !important; margin: 0 !important; width: 100% !important; }
            section { page-break-before: always; margin-top: 0 !important; padding-top: 2rem !important; border: none; box-shadow: none; }
            section:first-child { page-break-before: auto; }
            .print-break-avoid { page-break-inside: avoid !important; }
            .bg-white { box-shadow: none !important; border: 1px solid #e2e8f0; }
            .print-highlight { background-color: #fff7ed !important; border: 1px solid #fed7aa !important; }
            .print-highlight-text { color: #1e3a8a !important; }
        }
    </style>
</head>
<body class="text-slate-700">

    <!-- Pantalla de Autenticación -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4" style="background-color: #0c1e3e;">
        <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <img src="https://app.getrewell.com/assets/loginRewellLogoXXXL-641263e2.png" alt="Logo de Rewell" class="max-w-[150px] w-full h-auto mx-auto mb-4">
                <h1 class="text-2xl font-bold text-slate-800">Bienvenido a Rewell AI</h1>
                <p class="text-slate-500">Accede o crea una cuenta para continuar</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Correo electrónico" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                <input type="password" id="login-password" placeholder="Contraseña" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-600 transition-colors">Iniciar Sesión</button>
            </form>
            
            <div class="text-center mt-4">
                <button type="button" id="forgot-password-button" class="text-sm text-orange-600 hover:underline focus:outline-none">¿Olvidaste tu contraseña?</button>
            </div>

            <div class="text-center my-4">
                <p class="text-slate-500 text-sm">¿No tienes una cuenta?</p>
            </div>

            <form id="register-form" class="space-y-4">
                <input type="email" id="register-email" placeholder="Correo electrónico" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                <input type="password" id="register-password" placeholder="Contraseña (mín. 6 caracteres)" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Crear Cuenta</button>
            </form>
            <p id="auth-error-message" class="text-red-500 text-sm mt-4 text-center"></p>
            <p id="auth-success-message" class="text-green-600 text-sm mt-4 text-center"></p>
            <p class="text-center text-xs text-slate-400 mt-8 pt-4 border-t border-slate-200">
                © 2025 Rewell. Rewell es propiedad de Heritas (www.heritas.com.ar).
            </p>
        </div>
    </div>

    <!-- Pantalla de Carga de Archivos -->
    <div id="upload-screen" class="min-h-screen relative flex items-center justify-center p-4 pb-24" style="background-color: #0c1e3e;">
        <div class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-xl flex flex-col md:flex-row overflow-hidden">
            <div class="w-full md:w-5/12 bg-slate-50 flex justify-center items-center p-8 md:p-12">
                <img src="https://app.getrewell.com/assets/loginRewellLogoXXXL-641263e2.png" alt="Logo de Rewell" class="max-w-[250px] w-full h-auto">
            </div>
            <div class="w-full md:w-7/12 p-8 flex flex-col justify-center">
                 <div class="text-center">
                    <div class="flex justify-between items-center mb-4">
                        <button id="show-history-button" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors text-sm">Mis Planes</button>
                        <button id="logout-button" class="bg-blue-200 text-blue-800 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition-colors text-sm">Cerrar Sesión</button>
                    </div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">Genera tu Panel Personalizado de hábitos Saludables con REWELL</h1>
                    <p class="text-slate-600 mb-6">Sube tu reporte de REWELL para comenzar.</p>
                    
                    <div id="single-file-view">
                        <div id="drop-zone-single" class="file-drop-zone border-2 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer hover:border-orange-500">
                            <input type="file" id="report-file-single" class="hidden" accept=".pdf">
                            <svg class="mx-auto h-12 w-12 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                            <p class="mt-3 text-slate-600"><span class="font-semibold text-orange-600">Sube tu reporte Rewell (completo, genética o microbioma)</span></p>
                            <p class="text-xs text-slate-500 mt-1">Arrastra o haz clic para seleccionar</p>
                        </div>
                    </div>
                    
                    <div id="file-list" class="mt-4 text-left text-sm"></div>
                    <button id="continue-to-questionnaire-button" class="mt-6 w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-600 transition-colors disabled:bg-slate-300 disabled:cursor-not-allowed">Continuar</button>
                     <p id="error-message" class="text-red-500 text-sm mt-4 hidden"></p>
                </div>
            </div>
        </div>
        <footer class="absolute bottom-0 left-0 right-0 p-6 text-center text-sm text-white opacity-80">
            © 2025 Rewell. Rewell es propiedad de Heritas (www.heritas.com.ar).
        </footer>
    </div>
    
    <!-- Historial de Reportes -->
    <div id="history-screen" class="min-h-screen bg-slate-50 py-12 px-4">
        <div class="max-w-4xl mx-auto">
             <div class="text-center mb-8">
                <img src="https://app.getrewell.com/assets/loginRewellLogoXXXL-641263e2.png" alt="Logo de Rewell" class="max-w-[150px] w-full h-auto mx-auto">
            </div>
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800">Mis Planes</h1>
                <button id="back-to-upload-from-history" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">Volver</button>
            </div>
             <p class="text-slate-600 mb-8 text-center bg-blue-50 p-4 rounded-lg border border-blue-200 text-sm">
                Si tienes un nuevo reporte de Rewell (por ej, Evolución continua microbioma) o si han cambiado las condiciones del cuestionario (por ej, una nueva condición diagnosticada, un cambio de dieta drástico o la incorporación de suplementos) puedes generar un nuevo plan de hábitos subiendo los nuevos reportes y contestando de nuevo el cuestionario. Nuestro coach de Rewell IA hará un gran trabajo.
            </p>
            <div id="history-list" class="space-y-4">
                <!-- Los reportes se cargarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Cuestionario -->
    <div id="questionnaire-screen" class="min-h-screen bg-slate-50 py-12 px-4">
        <!-- El contenido del cuestionario no cambia, se omite por brevedad -->
        <div class="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
            <div class="flex justify-center mb-6">
                <img src="https://app.getrewell.com/assets/loginRewellLogoXXXL-641263e2.png" alt="Logo de Rewell" class="max-w-[125px] w-full h-auto">
            </div>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2 text-center">Cuestionario de Bienestar</h1>
            <p class="text-slate-600 mb-8 text-center">Tus respuestas nos ayudarán a personalizar aún más tus recomendaciones.</p>
            <form id="wellness-form" class="space-y-4">
                <!-- Pregunta 1: Alergias -->
                <div class="accordion-item border border-slate-200 rounded-lg">
                    <button type="button" class="accordion-header w-full flex justify-between items-center p-4 text-left font-semibold text-slate-700 hover:bg-slate-50">
                        <span>1. ¿Tenés alguna intolerancia o alergia alimentaria?</span>
                        <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content p-4 border-t border-slate-200">
                        <p class="text-sm text-slate-500 mb-4">Seleccioná todas las opciones que correspondan:</p>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="No tengo" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">No tengo</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Gluten o trigo" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Gluten o trigo</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Maní" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Maní</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Frutos secos" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Frutos secos</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Legumbres" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Legumbres</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Cereales" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Cereales</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Cítricos" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Cítricos</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Mariscos y pescados" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Mariscos y pescados</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Fructosa" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Fructosa</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Sacarosa" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Sacarosa</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Huevo" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Huevo</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Caseína" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Caseína</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Lactosa" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Lactosa</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Sulfitos" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Sulfitos</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Histamina" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Histamina</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Salicilatos" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Salicilatos</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Aspartamo" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Aspartamo</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Colorantes alimenticios" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Colorantes</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Aditivos alimentarios" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Aditivos</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="alergias" value="Soja" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Soja</span></label></div>
                        </div>
                    </div>
                </div>
                <!-- Pregunta 2: Síntomas -->
                <div class="accordion-item border border-slate-200 rounded-lg">
                    <button type="button" class="accordion-header w-full flex justify-between items-center p-4 text-left font-semibold text-slate-700 hover:bg-slate-50">
                        <span>2. ¿Presentás alguno de estos síntomas de manera frecuente?</span>
                        <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content p-4 border-t border-slate-200">
                         <p class="text-sm text-slate-500 mb-4">Seleccioná todos los que apliquen:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Dolor abdominal, pesadez, distensión, gases, reflujo" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Dolor abdominal, pesadez, gases, etc.</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Dolor de cabeza, migrañas" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Dolor de cabeza, migrañas</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Broncoespasmo, asma" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Broncoespasmo, asma</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Taquicardia, palpitaciones, hipotensión" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Taquicardia, palpitaciones, etc.</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Calambres, mareos" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Calambres, mareos</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Diarrea" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Diarrea</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Picazón e hinchazón de la boca" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Picazón e hinchazón de la boca</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Vómitos" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Vómitos</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Otras reacciones alérgicas cutáneas" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Reacciones cutáneas (urticaria, etc.)</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Rinitis, secreción o congestión nasal" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Rinitis, congestión nasal</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="Garganta apretada y dificultad para respirar" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Dificultad para respirar</span></label></div>
                             <div><label class="flex items-center"><input type="checkbox" name="sintomas" value="No presento ninguno de los síntomas" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">No presento síntomas frecuentes</span></label></div>
                        </div>
                    </div>
                </div>
                <!-- Pregunta 3: Dieta -->
                <div class="accordion-item border border-slate-200 rounded-lg">
                    <button type="button" class="accordion-header w-full flex justify-between items-center p-4 text-left font-semibold text-slate-700 hover:bg-slate-50">
                        <span>3. ¿Cómo definirías tu tipo de dieta habitual?</span>
                        <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content p-4 border-t border-slate-200">
                        <p class="text-sm text-slate-500 mb-4">Seleccioná una sola opción:</p>
                        <div class="space-y-2 text-sm">
                            <div><label class="flex items-center"><input type="radio" name="dieta" value="Vegana" class="h-4 w-4 border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Vegana</span></label></div>
                            <div><label class="flex items-center"><input type="radio" name="dieta" value="Vegetariana" class="h-4 w-4 border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Vegetariana</span></label></div>
                            <div><label class="flex items-center"><input type="radio" name="dieta" value="Libre de gluten" class="h-4 w-4 border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Libre de gluten</span></label></div>
                            <div><label class="flex items-center"><input type="radio" name="dieta" value="Tipo mediterránea" class="h-4 w-4 border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Tipo mediterránea</span></label></div>
                            <div><label class="flex items-center"><input type="radio" name="dieta" value="Baja en carbohidratos (Paleo o Cetogénica)" class="h-4 w-4 border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Baja en carbohidratos (Paleo/Keto)</span></label></div>
                            <div><label class="flex items-center"><input type="radio" name="dieta" value="Variada con alimentos de origen animal y vegetal" class="h-4 w-4 border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Variada (animal y vegetal)</span></label></div>
                            <div><label class="flex items-center"><input type="radio" name="dieta" value="Baja en FODMAPs" class="h-4 w-4 border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Baja en FODMAPs</span></label></div>
                            <div><label class="flex items-center"><input type="radio" name="dieta" value="No sigo ninguna dieta específica" class="h-4 w-4 border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">No sigo ninguna dieta específica</span></label></div>
                        </div>
                    </div>
                </div>
                <!-- Pregunta 4: Condiciones Médicas -->
                <div class="accordion-item border border-slate-200 rounded-lg">
                    <button type="button" class="accordion-header w-full flex justify-between items-center p-4 text-left font-semibold text-slate-700 hover:bg-slate-50">
                        <span>4. ¿Alguna vez te han diagnosticado alguna de estas condiciones médicas?</span>
                        <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content p-4 border-t border-slate-200">
                         <p class="text-sm text-slate-500 mb-4">Podés seleccionar más de una:</p>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Enfermedad cardiovascular" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Cardiovascular</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Diabetes tipo I" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Diabetes tipo I</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Diabetes tipo II" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Diabetes tipo II</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Hipertensión arterial" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Hipertensión</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Colesterol elevado" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Colesterol elevado</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Triglicéridos elevados" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Triglicéridos elevados</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Úlcera" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Úlcera</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Reflujo gastroesofágico" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Reflujo</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Enfermedades digestivas" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Digestivas</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Enfermedad de Crohn o colitis ulcerosa" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Crohn/Colitis</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Síndrome de intestino o colon irritable" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Colon irritable</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="SIBO" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">SIBO</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Endometriosis" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Endometriosis</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Ovario poliquístico" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Ovario poliquístico</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Condiciones pulmonares/respiratorias" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Respiratorias</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Osteoporosis" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Osteoporosis</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Enfermedad tiroidea" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Tiroidea</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="condiciones" value="Ninguna" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Ninguna</span></label></div>
                        </div>
                    </div>
                </div>
                <!-- Pregunta 5: Suplementos -->
                <div class="accordion-item border border-slate-200 rounded-lg">
                    <button type="button" class="accordion-header w-full flex justify-between items-center p-4 text-left font-semibold text-slate-700 hover:bg-slate-50">
                        <span>5. En una semana típica, ¿cuáles de estas vitaminas y/o suplementos tomás?</span>
                        <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content p-4 border-t border-slate-200">
                        <p class="text-sm text-slate-500 mb-4">Por favor, seleccioná todos los que aplican:</p>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="No tomo suplementos" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">No tomo</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Multivitamínicos" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Multivitamínicos</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Melatonina" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Melatonina</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Omega 3" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Omega 3</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Vitamina A" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Vitamina A</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Vitamina B1-B6" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Vitamina B1-B6</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Biotina" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Biotina</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Ácido fólico" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Ácido fólico</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Vitamina C" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Vitamina C</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Vitamina D" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Vitamina D</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Vitamina E, H o K" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Vitamina E, H o K</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Minerales (Calcio, magnesio, etc.)" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Minerales</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Probióticos" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Probióticos</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Prebióticos" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Prebióticos</span></label></div>
                            <div><label class="flex items-center"><input type="checkbox" name="suplementos" value="Colágeno" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> <span class="ml-2">Colágeno</span></label></div>
                        </div>
                    </div>
                </div>
            </form>
            <div class="mt-8 flex flex-col-reverse sm:flex-row justify-center gap-4">
                 <button id="back-to-upload-button" type="button" class="w-full sm:w-auto bg-slate-100 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-200 transition-colors border border-slate-300">
                    Volver
                </button>
                <button id="analyze-button" class="w-full sm:w-auto bg-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-600 transition-colors">
                    Generar mi Panel
                </button>
            </div>
        </div>
    </div>

    <!-- Pantalla de Carga -->
    <div id="loading-screen" class="min-h-screen flex items-center justify-center p-4 text-center">
        <div>
            <div class="flex justify-center items-center space-x-2 mb-6">
                <div class="dot-pulse h-8 w-8 bg-orange-500 rounded-full"></div>
                <div class="dot-pulse h-8 w-8 bg-orange-500 rounded-full"></div>
                <div class="dot-pulse h-8 w-8 bg-orange-500 rounded-full"></div>
            </div>
            <h2 id="loading-title" class="text-2xl font-semibold text-slate-700 mb-2">Analizando tus reportes...</h2>
            <p id="loading-text" class="text-slate-500">El análisis puede demorar entre 3 y 5 minutos. ¡Puedes ir a buscar un café si quieres!</p>
        </div>
    </div>

    <!-- Pantalla de Resultados -->
    <div id="results-screen">
        <!-- El contenido se generará aquí dinámicamente -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ==================================================================
        // ===== CONFIGURACIÓN DE FIREBASE - ¡REEMPLAZAR! =====
        // ==================================================================
        // TODO: Reemplaza este objeto con la configuración de tu propio proyecto de Firebase.
        const firebaseConfig = {
          apiKey: "AIzaSyDkORryISKbYW5xbi1hkbSlUR8xS_VGMZI",
          authDomain: "rewell-ai-app.firebaseapp.com",
          projectId: "rewell-ai-app",
          storageBucket: "rewell-ai-app.firebasestorage.app",
          messagingSenderId: "1004160160765",
          appId: "1:1004160160765:web:e029e012e5e4e0638f7f94"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ==================================================================
        // ===== LÓGICA DE LA APLICACIÓN =====
        // ==================================================================
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        document.addEventListener('DOMContentLoaded', () => {
            // Screen elements
            const screens = {
                auth: document.getElementById('auth-screen'),
                upload: document.getElementById('upload-screen'),
                questionnaire: document.getElementById('questionnaire-screen'),
                loading: document.getElementById('loading-screen'),
                results: document.getElementById('results-screen'),
                history: document.getElementById('history-screen'),
            };

            // Auth elements
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const authErrorMessage = document.getElementById('auth-error-message');
            const authSuccessMessage = document.getElementById('auth-success-message');
            const logoutButton = document.getElementById('logout-button');
            const forgotPasswordButton = document.getElementById('forgot-password-button');
            
            // Upload elements
            const continueToQuestionnaireButton = document.getElementById('continue-to-questionnaire-button');
            const errorMessage = document.getElementById('error-message');
            const dropZoneSingle = document.getElementById('drop-zone-single');
            const fileInputSingle = document.getElementById('report-file-single');
            const fileList = document.getElementById('file-list');

            // Other buttons
            const analyzeButton = document.getElementById('analyze-button');
            const backToUploadButton = document.getElementById('back-to-upload-button');
            const showHistoryButton = document.getElementById('show-history-button');
            const backToUploadFromHistory = document.getElementById('back-to-upload-from-history');
            
            // Loading elements
            const loadingTitle = document.getElementById('loading-title');
            const loadingText = document.getElementById('loading-text');
            
            // History elements
            const historyList = document.getElementById('history-list');

            // App state
            let reportFile = null;
            let currentUserName = 'Usuario';
            const MAX_FILE_SIZE_SINGLE = 25 * 1024 * 1024; // 25 MB

            // --- Screen Manager ---
            const showScreen = (screenName) => {
                Object.values(screens).forEach(screen => screen.style.display = 'none');
                if (screens[screenName]) {
                    screens[screenName].style.display = 'flex'; // Use flex for centered screens
                    if (screenName === 'results' || screenName === 'questionnaire' || screenName === 'history') {
                         screens[screenName].style.display = 'block'; // Use block for full-width screens
                    }
                }
            };

            // --- Auth Logic ---
            onAuthStateChanged(auth, user => {
                if (user && user.emailVerified) {
                    showScreen('upload'); // User is signed in AND verified
                } else {
                    showScreen('auth'); // User is signed out or not verified
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                authSuccessMessage.textContent = '';
                authErrorMessage.textContent = '';
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await sendEmailVerification(userCredential.user);
                    await signOut(auth); // Sign out the user immediately after registration
                    authSuccessMessage.textContent = '¡Cuenta creada! Revisa tu correo para verificar tu cuenta antes de iniciar sesión.';
                    registerForm.reset();
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        authErrorMessage.textContent = 'Este correo electrónico ya está en uso.';
                    } else {
                        authErrorMessage.textContent = `Error al registrar: ${error.message}`;
                    }
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                authSuccessMessage.textContent = '';
                authErrorMessage.textContent = '';
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    if (!userCredential.user.emailVerified) {
                        await signOut(auth);
                        authErrorMessage.textContent = 'Por favor, verifica tu correo electrónico para poder iniciar sesión.';
                    }
                    // If verified, onAuthStateChanged will handle showing the next screen.
                } catch (error) {
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential' || error.code === 'auth/invalid-login-credentials') {
                        authErrorMessage.textContent = 'Tu usuario o contraseña son erróneos.';
                    } else {
                        authErrorMessage.textContent = `Error al iniciar sesión: ${error.message}`;
                    }
                }
            });

            forgotPasswordButton.addEventListener('click', async () => {
                authSuccessMessage.textContent = '';
                authErrorMessage.textContent = '';
                const email = document.getElementById('login-email').value;
                if (!email) {
                    authErrorMessage.textContent = 'Por favor, ingresa tu correo para restablecer la contraseña.';
                    return;
                }
                try {
                    await sendPasswordResetEmail(auth, email);
                    authSuccessMessage.textContent = 'Correo de restablecimiento enviado. Revisa tu bandeja de entrada.';
                } catch (error) {
                    if (error.code === 'auth/user-not-found') {
                        authErrorMessage.textContent = 'No se encontró un usuario con ese correo.';
                    } else {
                        authErrorMessage.textContent = `Error: ${error.message}`;
                    }
                }
            });

            logoutButton.addEventListener('click', async () => {
                await signOut(auth);
            });

            // --- Upload & File Logic ---
            const showError = (message, isAuthError = false) => {
                const target = isAuthError ? authErrorMessage : errorMessage;
                target.textContent = message;
                target.classList.toggle('hidden', !message);
            };
            
            const updateButtonState = () => {
                continueToQuestionnaireButton.disabled = !reportFile;
            };

            const updateFileListUI = () => {
                fileList.innerHTML = '';
                if (reportFile) fileList.innerHTML = `<p class="text-slate-600 bg-emerald-50 p-2 rounded-md"><span class="font-semibold text-emerald-700">✓ Reporte Cargado:</span> ${reportFile.name}</p>`;
            };

            const handleFile = (file) => {
                if (!file) return;
                if (file.type !== 'application/pdf') {
                    showError(`El archivo "${file.name}" no es un PDF.`);
                    return;
                }
                if (file.size > MAX_FILE_SIZE_SINGLE) {
                    showError(`El archivo "${file.name}" es demasiado grande (máx. 25 MB).`);
                } else {
                    reportFile = file;
                    showError("");
                }
                updateFileListUI();
                updateButtonState();
            };

            const setupDropZone = (dropZone, fileInput) => {
                dropZone.addEventListener('click', () => fileInput.click());
                ['dragover', 'dragenter'].forEach(eventName => dropZone.addEventListener(eventName, e => { e.preventDefault(); dropZone.classList.add('dragover'); }));
                ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, e => { e.preventDefault(); dropZone.classList.remove('dragover'); }));
                dropZone.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
                fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
            };

            setupDropZone(dropZoneSingle, fileInputSingle);

            const pdfToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.toString().replace(/^data:.+;base64,/, ''));
                reader.onerror = error => reject(error);
            });
            
            const resetAppToUpload = () => {
                showScreen('upload');
                reportFile = null;
                currentUserName = 'Usuario';
                fileInputSingle.value = "";
                document.getElementById('wellness-form').reset();
                updateFileListUI();
                showError("");
                updateButtonState();
            };

            async function extractDataFromPdf(file) {
                // ... (la función extractDataFromPdf no cambia, se omite por brevedad)
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const pdf = await pdfjsLib.getDocument({ data: event.target.result }).promise;
                            let isRewellReport = false;
                            let userName = 'Usuario';
                            for (let pageNum = 1; pageNum <= Math.min(5, pdf.numPages); pageNum++) {
                                const page = await pdf.getPage(pageNum);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(' ').replace(/\s+/g, ' ');
                                const idMatch = pageText.match(/ID Kit\s*"?\s*([A-Z0-9]+)/i);
                                if (idMatch && idMatch[1]) {
                                    userName = idMatch[1].trim();
                                    isRewellReport = true;
                                    resolve({ isValid: true, userName: userName });
                                    return;
                                }
                            }
                            if (userName === 'Usuario') {
                                for (let pageNum = 1; pageNum <= Math.min(5, pdf.numPages); pageNum++) {
                                    const page = await pdf.getPage(pageNum);
                                    const textContent = await page.getTextContent();
                                    const pageText = textContent.items.map(item => item.str).join(' ').replace(/\s+/g, ' ');
                                    const nameMatch = pageText.match(/Usuario\s*"?\s*([^"]+?)\s*"?\s*Fecha de nacimiento/i);
                                    if (nameMatch && nameMatch[1]) {
                                        const extractedName = nameMatch[1].trim();
                                        userName = extractedName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                                        isRewellReport = true;
                                        break;
                                    }
                                }
                            }
                            if (!isRewellReport) {
                                for (let pageNum = 1; pageNum <= Math.min(5, pdf.numPages); pageNum++) {
                                    const page = await pdf.getPage(pageNum);
                                    const textContent = await page.getTextContent();
                                    const pageText = textContent.items.map(item => item.str).join(' ').toUpperCase();
                                    if (pageText.includes("FECHA DE REPORTE")) {
                                        isRewellReport = true;
                                        break;
                                    }
                                }
                            }
                            if (isRewellReport) {
                                resolve({ isValid: true, userName: userName });
                            } else {
                                reject(new Error(`El archivo "${file.name}" no parece ser un reporte de Rewell válido.`));
                            }
                        } catch (error) {
                            reject(new Error(`No se pudo leer o procesar el archivo PDF: "${file.name}".`));
                        }
                    };
                    reader.onerror = () => {
                        reject(new Error(`Error al leer el archivo: "${file.name}".`));
                    };
                    reader.readAsArrayBuffer(file);
                });
            }
            
            continueToQuestionnaireButton.addEventListener('click', async () => {
                 if (!reportFile) {
                    showError("Por favor, sube tu reporte.");
                    return;
                }
                showError("");
                try {
                    const { isValid, userName } = await extractDataFromPdf(reportFile);
                    if (!isValid) throw new Error(`El archivo "${reportFile.name}" no es un reporte válido.`);
                    currentUserName = userName;
                    showScreen('questionnaire');
                } catch (validationError) {
                    showError(validationError.message);
                }
            });

            backToUploadButton.addEventListener('click', () => showScreen('upload'));

            const getQuestionnaireData = (asObject = false) => {
                const form = document.getElementById('wellness-form');
                const formData = new FormData(form);
                const dataObject = {
                    alergias: formData.getAll('alergias').join(', ') || 'Ninguna',
                    sintomas: formData.getAll('sintomas').join(', ') || 'Ninguno',
                    dieta: formData.get('dieta') || 'No especificada',
                    condiciones: formData.getAll('condiciones').join(', ') || 'Ninguna',
                    suplementos: formData.getAll('suplementos').join(', ') || 'Ninguno'
                };
                if (asObject) return dataObject;
                let questionnaireText = "## Respuestas del Cuestionario de Bienestar del Usuario\n\n";
                questionnaireText += `**1. Intolerancias o alergias alimentarias:**\n- ${dataObject.alergias}\n\n`;
                questionnaireText += `**2. Síntomas frecuentes:**\n- ${dataObject.sintomas}\n\n`;
                questionnaireText += `**3. Tipo de dieta habitual:**\n- ${dataObject.dieta}\n\n`;
                questionnaireText += `**4. Condiciones médicas diagnosticadas:**\n- ${dataObject.condiciones}\n\n`;
                questionnaireText += `**5. Vitaminas y/o suplementos tomados:**\n- ${dataObject.suplementos}\n\n`;
                return questionnaireText;
            };

            const handleAnalysis = async () => {
                // WARNING: Exposing API keys client-side is a security risk.
                const apiKey = "AIzaSyASKTV6JD2FfHqH7HTKbeXVnmn2pQJ_OvQ"; 
                
                showScreen('loading');
                loadingTitle.textContent = "Analizando tu reporte y cuestionario...";
                loadingText.textContent = "El análisis puede demorar entre 3 y 5 minutos. ¡Puedes ir a buscar un café si quieres!";

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                    let parts = [];
                    const questionnaireDataForGemini = getQuestionnaireData(false);
                    const prompt = `Actúa como un coach de salud y diseñador de UI/UX experto en nutrigenética y microbioma intestinal. Tu tarea es analizar un reporte de REWELL en PDF (que contiene genética y microbioma) Y las respuestas a un cuestionario de salud. Debes generar un panel de bienestar visualmente atractivo, integrado, accionable y ALTAMENTE PERSONALIZADO.`;
                    
                    parts.push({ text: prompt });
                    parts.push({ text: questionnaireDataForGemini });
                    parts.push({ inlineData: { mimeType: "application/pdf", data: await pdfToBase64(reportFile) } });

                    // ==================================================================
                    // ===== INSTRUCCIONES REFORZADAS PARA LA IA =====
                    // ==================================================================
                    const commonInstructions = `
                        **REGLA DE ORO: NO escribas NINGÚN texto introductorio, saludo o explicación antes del código HTML. Tu respuesta DEBE comenzar DIRECTAMENTE con la etiqueta \`<header>\`. Cualquier texto fuera del código HTML resultará en un error.**

                        **Misión Crítica:** Genera el CÓDGIO HTML COMPLETO para el panel de resultados. El HTML debe incluir un <header>, un <main> y un <footer>. El diseño debe tener una barra de navegación superior fija y un contenido principal bien estructurado con tarjetas e iconos. El nombre del usuario es: "${currentUserName}". Usa este nombre en el panel.

                        **Análisis y Contenido Requerido - PRESTA MUCHA ATENCIÓN:**
                        
                        1.  **Estilo para "Acciones Concretas":** Es **VITAL** que CADA VEZ que generes un título "**Acciones Concretas:**" y su lista de recomendaciones, los envuelvas en un \`<div class="bg-orange-100 text-blue-800 p-4 rounded-lg mt-4 print-highlight print-break-avoid">\`. El título "**Acciones Concretas:**" debe tener la clase \`font-semibold\`. Todo el texto dentro de este div debe tener la clase \`print-highlight-text\`.
                        2.  **Extracción de Datos Clave:** Del reporte, extrae y destaca específicamente los hallazgos negativos como: baja producción de SCFA/Butirato, desbalance en el ratio Firmicutes/Bacteroidetes, niveles elevados de Proteobacterias, y cualquier predisposición a constipación o inflamación. Estos deben ser puntos centrales en las recomendaciones.

                        **Estructura del Reporte de Salida (HTML):**

                        1.  **Header Fijo:** Un \`<header class="bg-white shadow-md sticky top-0 z-50 no-print">\` que contenga un \`<h1>\` "Tu Panel de Bienestar, ${currentUserName}", una barra de navegación con enlaces a las 5 secciones, y dos botones: "Exportar a PDF" \`<button id="print-button" ...>\` y "Reiniciar" \`<button id="reset-button" ...>\`.
                        2.  **Contenido Principal (<main>):**
                            * **Sección 1 (id="seccion1"): Puntos de Atención Clave:** * **REGLA CRÍTICA:** Para esta sección, debes basar las sugerencias **FUNDAMENTALMENTE en los hallazgos más importantes del reporte PDF (genética y microbioma)**, no en el cuestionario. El objetivo es resaltar los datos científicos más relevantes.
                                * **REGLA CRÍTICA:** Cada una de las tres tarjetas debe contener un **MÁXIMO de 5 puntos**. Sé conciso y prioriza el mayor impacto.
                                * **REGLA DE DISEÑO:** La tarjeta "Tus Fortalezas" debe tener un fondo verde claro (\`bg-emerald-50\`) y título verde (\`text-emerald-700\`). La tarjeta "Tus Áreas de Atención" debe tener un fondo naranja claro (\`bg-orange-50\`) y título naranja (\`text-orange-700\`). La tarjeta "Tus Puntos de Acción Prioritarios" debe tener un fondo rojo claro (\`bg-red-50\`) y título rojo (\`text-red-700\`).
                                * Cada tarjeta debe tener la clase \`print-break-avoid\`.
                            * **Sección 2 (id="seccion2"): Tu Estado Vitamínico (Genética + Microbioma):** Título claro con un icono SVG. Esta sección es CRÍTICA y **DEBE ESTAR SIEMPRE PRESENTE**. Debe tener un grid de tarjetas (2 o 3 columnas). Cada tarjeta representa una vitamina en estado de atención o prioritario. La tarjeta debe detallar claramente: "**Hallazgo Genético:**", "**Hallazgo del Microbioma:**" (si aplica, si no, debes poner "No presenta deficiencias"), "**Información Adicional (Cuestionario):**" (ej. "Mencionaste no tomar suplementos de Vitamina D"), y la sección de "**Acciones Concretas:**" (que debe estar resaltada). Todas las tarjetas deben tener la clase \`print-break-avoid\`.
                            * **Sección 3 (id="seccion3"): Tu Estrategia de Nutrición y Plan Semanal:**
                                * **REGLA CRÍTICA:** Debes presentar **SIEMPRE** una tabla HTML completa con el título "Tu Plan Nutricional Semanal Educativo". Usa las clases de Tailwind \`w-full table-auto text-sm text-left\`.
                                * **REGLA CRÍTICA:** La tabla debe tener un encabezado (\`<thead>\`) con las columnas: **Día, Desayuno, Almuerzo, Snack, Cena, Beneficio Clave**.
                                * **REGLA CRÍTICA:** El cuerpo de la tabla (\`<tbody>\`) debe contener una fila (\`<tr>\`) para cada día de la semana, de Lunes a Domingo.
                                * **REGLA CRÍTICA:** La columna "Beneficio Clave" **DEBE** ser muy específica y educativa, vinculando directamente la comida con un hallazgo del reporte, ej: 'Aporta fibra para tus bacterias productoras de Butirato (detectadas como bajas) y es bajo en [alérgeno del cuestionario]'.
                                * La tabla debe estar dentro de un div con la clase \`overflow-x-auto\` para ser responsive en móviles.
                            * **Sección 4 (id="seccion4"): Bienestar, Deporte y Descanso:** Título claro con un icono SVG. **DEBE TENER un layout de 2 columnas en pantallas medianas y grandes (md:grid-cols-2)**.
                                * **Columna 1 "Tu Perfil de Entrenamiento":** Debe comenzar con **una oración clara que resuma las fortalezas y puntos de atención del usuario** (ej: "Tu genética te favorece en deportes de potencia, pero indica un mayor riesgo de lesiones musculares..."). Luego, presentar la tarjeta con las "**Acciones Concretas:**" resaltadas.
                                * **Columna 2 "Tu Perfil de Descanso":** Debe comenzar con **una oración clara que resuma las fortalezas y puntos de atención del usuario** (ej: "Si bien no presentas dificultad para conciliar el sueño, tu genética sugiere un sueño más liviano..."). Luego, presentar la tarjeta con las "**Acciones Concretas:**" resaltadas.
                                * Todas las tarjetas deben tener la clase \`print-break-avoid\`.
                            * **Sección 5 (id="seccion5"): Salud Preventiva y Microbioma:** Título claro con un icono SVG. **DEBE ESTAR SIEMPRE PRESENTE Y TENER un layout de 2 columnas en pantallas medianas y grandes (md:grid-cols-2)**.
                                * **Columna 1 "Salud Preventiva":** Resaltar claramente los riesgos genéticos a tener en cuenta (ej. Tiroiditis, etc.) y proveer "**Acciones Concretas:**" bien claras para la prevención.
                                * **Columna 2 "Claves de tu Microbioma":** Resaltar los hallazgos más importantes del microbioma (ej. Proteobacterias elevadas) y proveer "**Acciones Concretas:**" específicas para mejorar esos indicadores.
                                * Todas las tarjetas deben tener la clase \`print-break-avoid\`.
                        3. **Footer:** Un \`<footer class="web-footer text-center p-6 mt-12 bg-slate-100 text-xs text-slate-500 no-print">\` con el texto legal.

                        **Instrucciones Adicionales:**
                        * El output debe ser únicamente el código HTML desde la etiqueta \`<header>\` hasta el final de la etiqueta \`</footer>\`. No incluyas \`<html>\`, \`<head>\`, \`<body>\`, ni el script de inicialización.
                        * El idioma de todo el contenido debe ser Español.
                        * Usa iconos SVG inline de Heroicons o similares para un look profesional.
                        * **CRÍTICO: No utilices gráficos de Chart.js ni la etiqueta <canvas>.**
                    `;
                    parts.push({ text: commonInstructions });

                    const payload = { contents: [{ role: "user", parts: parts }] };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`Error de la API: ${response.statusText}`);
                    
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                        let htmlContent = result.candidates[0].content.parts[0].text.replace(/```html/g, '').replace(/```/g, '');
                        
                        // Guardar en Firestore
                        const user = auth.currentUser;
                        if (user) {
                            await addDoc(collection(db, "users", user.uid, "reports"), {
                                userId: user.uid,
                                userName: currentUserName,
                                timestamp: new Date(),
                                questionnaireData: getQuestionnaireData(true),
                                recommendationHtml: htmlContent
                            });
                        }

                        screens.results.innerHTML = htmlContent;
                        showScreen('results');
                        initializeResultsScreen();
                    } else {
                        throw new Error("Respuesta inesperada o vacía de la API.");
                    }
                } catch (error) {
                    showError(`Ocurrió un error al analizar: ${error.message}`);
                    showScreen('upload');
                }
            };
            
            const exportToPdf = async () => {
                // ... (la función exportToPdf no cambia, se omite por brevedad)
                const printButton = document.getElementById('print-button');
                const mainContent = document.querySelector('#results-screen main');
                if (!mainContent) return;
                printButton.textContent = 'Exportando...';
                printButton.disabled = true;
                const canvas = await html2canvas(mainContent, { scale: 2, useCORS: true, logging: false, windowWidth: mainContent.scrollWidth, windowHeight: mainContent.scrollHeight });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasAspectRatio = canvas.width / canvas.height;
                const imgHeight = pdfWidth / canvasAspectRatio;
                let heightLeft = imgHeight;
                let position = 0;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;
                while (heightLeft > 0) {
                    position = -pdfHeight * (pdf.internal.getNumberOfPages());
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }
                pdf.save(`Panel_Bienestar_${currentUserName.replace(/\s/g, '_')}.pdf`);
                printButton.textContent = 'Exportar a PDF';
                printButton.disabled = false;
            };

            const initializeResultsScreen = () => {
                const resetButton = document.getElementById('reset-button');
                if (resetButton) resetButton.addEventListener('click', resetAppToUpload);
                const printButton = document.getElementById('print-button');
                if(printButton) printButton.addEventListener('click', exportToPdf);
                initializeNav();
            };
            
            // --- History Logic ---
            showHistoryButton.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;
                
                showScreen('loading');
                loadingTitle.textContent = "Cargando tus planes...";
                loadingText.textContent = "";

                historyList.innerHTML = '';
                try {
                    const q = query(collection(db, "users", user.uid, "reports"), orderBy("timestamp", "desc"));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        historyList.innerHTML = '<p class="text-slate-500 text-center">No tienes planes guardados todavía.</p>';
                    } else {
                        querySnapshot.forEach(doc => {
                            const report = doc.data();
                            const date = report.timestamp.toDate().toLocaleString('es-AR');
                            const reportElement = document.createElement('div');
                            reportElement.className = 'bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-all cursor-pointer border-2 border-transparent hover:border-orange-500';
                            reportElement.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="font-semibold text-lg text-slate-800">${report.userName}</h3>
                                        <p class="text-sm text-slate-500">${date}</p>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                    </svg>
                                </div>
                            `;
                            reportElement.addEventListener('click', () => {
                                screens.results.innerHTML = report.recommendationHtml;
                                showScreen('results');
                                initializeResultsScreen();
                            });
                            historyList.appendChild(reportElement);
                        });
                    }
                    showScreen('history');
                } catch (error) {
                    showError(`Error al cargar el historial: ${error.message}`);
                    showScreen('upload');
                }
            });

            backToUploadFromHistory.addEventListener('click', () => showScreen('upload'));

            // --- Initializers ---
            document.querySelectorAll('.accordion-header').forEach(button => {
                button.addEventListener('click', () => {
                    const accordionContent = button.nextElementSibling;
                    const accordionIcon = button.querySelector('svg');
                    if (accordionContent.style.maxHeight) {
                        accordionContent.style.maxHeight = null;
                        accordionIcon.style.transform = 'rotate(0deg)';
                    } else {
                        accordionContent.style.maxHeight = accordionContent.scrollHeight + "px";
                        accordionIcon.style.transform = 'rotate(180deg)';
                    } 
                });
            });

            analyzeButton.addEventListener('click', handleAnalysis);
            updateButtonState();
        });

        function initializeNav() {
            try {
                const navLinks = document.querySelectorAll('.nav-link');
                const sections = document.querySelectorAll('main section');
                if (navLinks.length > 0 && sections.length > 0) {
                    const observer = new IntersectionObserver((entries) => {
                        let visibleSectionId = null;
                        entries.forEach(entry => {
                            if (entry.isIntersecting && !visibleSectionId) {
                                visibleSectionId = entry.target.id;
                            }
                        });
                        if (visibleSectionId) {
                            navLinks.forEach(link => {
                                const linkHref = link.getAttribute('href');
                                if (linkHref) {
                                   link.classList.toggle('active', linkHref.substring(1) === visibleSectionId);
                                }
                            });
                        }
                    }, { root: null, rootMargin: '0px 0px -50% 0px', threshold: 0.5 });
                    sections.forEach(section => observer.observe(section));
                }
            } catch (e) {
                console.error("Error al inicializar la navegación:", e);
            }
        }
    </script>
</body>
</html>
